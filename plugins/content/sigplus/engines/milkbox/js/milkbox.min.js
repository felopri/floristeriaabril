/*

 Milkbox v2.3.2 - required: mootools.js v1.2.3 core + more 1.2.3.1: Assets

 by Luca Reghellin (http://www.reghellin.com) August 2009, MIT-style license.
 Inspiration Lokesh Dhakar (http://www.lokeshdhakar.com/projects/lightbox2/)
 AND OF COURSE, SPECIAL THANKS TO THE MOOTOOLS DEVELOPERS
*/
var Milkbox=new Class({Implements:[Options,Events],options:{overlayOpacity:0.7,topPosition:50,initialWidth:250,initialHeight:250,canvasBorderWidth:"0px",canvasBorderColor:"#000000",canvasPadding:"0px",resizeDuration:500,resizeTransition:"sine:in:out",autoPlay:false,autoPlayDelay:7,removeTitle:false,autoSize:true,maxHeight:0,imageOfText:"/",onXmlGalleries:$empty,onClosed:$empty,onFileReady:$empty},initialize:function(a){this.setOptions(a);this.autoPlayBkup={autoPlayDelay:this.options.autoPlayDelay,
autoPlay:this.options.autoPlay};this.fullOptionsBkup={};this.galleries=[];this.families=[];this.xmlFiles=[];this.loadedImages=[];this.mode=this.currentResponse=this.currentRequest=this.currentGallery=this.currentIndex=this.currentFile=null;this.paused=this.busy=this.closed=true;this.eventsok=this.fileReady=false;this.first=true;this.activated=false;this.formtags=this.intObj=null;this.prepareGalleries();if(this.options.overlayOpacity==0)this.options.overlayOpacity=1.0E-4;this.saveOptions();this.galleries.length!=
0&&this.initMilkbox(true)},initMilkbox:function(a){if(a)this.formtags=$$("select","textarea");this.prepareHTML();this.prepareEffects();this.prepareEvents();this.activated=true},openMilkbox:function(a,b){this.closed=false;this.formtags&&this.formtags.length!=0&&this.formtags.setStyle("display","none");this.overlay.setStyles({top:-$(window).getScroll().y,height:$(window).getScrollSize().y+$(window).getScroll().y});this.center.setStyle("top",$(window).getScroll().y+this.options.topPosition);this.currentGallery=
a;this.currentIndex=b;this.overlay.tween("opacity",this.options.overlayOpacity);if(a.length==1){this.mode="singleFile";this.loadFile(a[b],b)}else{this.mode="fileGallery";var c=0;$$(this.prev,this.next,this.count).setStyle("display","block");if(this.options.autoPlay){this.playpause.setStyle("display","block");c=this.playpause.getSize().x}var d=this.center.getStyle("border-right-width").toInt();c=this.prev.getSize().x+this.next.getSize().x+this.close.getSize().x+c+d;this.navigation.setStyle("width",
c);this.description.setStyle("margin-right",c);c=b!=a.length-1?a[b+1]:a[0];d=b!=0?a[b-1]:a[a.length-1];this.loadFile(a[b],d==c?[d]:[d,c])}},loadFile:function(a,b){this.fileReady=false;if(this.checkFileType(a,"swf"))this.loadSwf(a);else{this.loadedImages.contains(a.retrieve("href"))||this.center.addClass("mbLoading");this.loadImage(a.retrieve("href"))}b&&this.preloadFiles(b)},preloadFiles:function(a){a.each(function(b){this.checkFileType(b.retrieve("href"),"swf")||this.preloadImage(b.retrieve("href"))},
this)},loadImage:function(a){new Asset.image(a,{onload:function(b){this.loadedImages.contains(a)||this.loadedImages.push(a);this.currentFile=b;this.loadAux(this.currentFile)}.bindWithEvent(this)})},preloadImage:function(a){this.loadedImages.contains(a)||new Asset.image(a,{onload:function(){this.loadedImages.push(a)}.bindWithEvent(this)})},loadSwf:function(a){this.currentFile=new Swiff(a.retrieve("href"),{width:a.retrieve("width").toInt(),height:a.retrieve("height").toInt(),params:{wMode:"opaque",
swLiveConnect:"false"}});this.loadAux(a)},loadAux:function(a){this.fileReady=true;this.fireEvent("fileReady");$$(this.description,this.navigation).setStyle("visibility","hidden");this.navigation.setStyle("height","");$$(this.next,this.prev,this.close).setStyle("backgroundPosition","0 0");this.showFile(a)},showFile:function(a){if(!this.closed){var b=new Hash,c=new Hash,d,e,f,g;d=e={};f=e=f=f=g=0;if(this.options.canvasBorderWidth.toInt()!=0&&this.canvas.getStyle("borderWidth").toInt()==0){f=this.options.canvasBorderWidth+
" solid "+this.options.canvasBorderColor;this.canvas.setStyle("border",f)}if(this.options.canvasPadding.toInt()!=0&&this.canvas.getStyle("padding").toInt()==0){f=this.options.canvasPadding;this.canvas.setStyle("padding",f)}e=this.canvas.getSize();f=this.canvas.getStyle("borderWidth").toInt()*2+this.canvas.getStyle("padding").toInt()*2;this.canvas.setStyles({opacity:0,width:"",height:""});if(a.retrieve("width"))b.extend({height:a.retrieve("height").toInt(),width:a.retrieve("width").toInt()});else{b=
b.extend(a.getProperties("width","height")).map(function(h){return h.toInt()});if(this.options.autoSize){b=this.computeSize(b);a.setProperties({width:b.width,height:b.height})}}c=c.extend(this.center.getStyles("width","height")).map(function(h){return h.toInt()});if(b.width!=c.width){d.width=b.width+f;d.marginLeft=-(d.width/2).round()}e=e.y-f>0?c.height-e.y:0;d.height=b.height+f+e;this.canvas.setStyles({width:b.width,height:b.height});this.center.removeClass("mbLoading");if(this.first){g=500;this.first=
false}(function(){this.center.morph(d)}).delay(g,this)}},computeSize:function(a){a=a;var b=window.getSize();b={width:b.x-60,height:b.y-68-this.options.topPosition*2};var c,d;d=Math.max(b.height,b.width);if(d==b.width){c=d/a.width;d="height"}else{c=d/a.height;d="width"}c=c<=1?c:1;a=a.map(function(e){return Math.floor(e*c)});c=b[d]/a[d]<=1?b[d]/a[d]:1;a=a.map(function(e){return Math.floor(e*c)});if(this.options.maxHeight>0){c=this.options.maxHeight/a.height<1?this.options.maxHeight/a.height:1;a=a.map(function(e){return Math.floor(e*
c)})}return a},showGallery:function(a){if(a&&a.gallery){var b=$chk(a.index)?a.index:0,c=this.getGallery(a.gallery),d=false;if(a.autoplay||c.options&&c.options.autoplay)d=true;if(c!=-1&&!this.opened)if(d){a=a&&a.delay?a.delay:c.options&&c.options.delay?c.options.delay:this.autoPlayDelay;this.startAutoPlay({gallery:c,index:b,delay:a})}else this.openMilkbox(c,b)}},addGalleries:function(a){this.currentRequest=new Request({method:"get",autoCancel:true,url:a,onRequest:function(){}.bindWithEvent(this),onSuccess:function(b){b=
b.replace(/(<a.+)\/>/gi,"$1></a>");this.setGalleries(new Element("div",{html:b}),a)}.bindWithEvent(this),onFailure:function(){alert("Milkbox :: addGalleries: XML file path error or local Ajax test: please test addGalleries() on-line")}});this.currentRequest.send()},setGalleries:function(a,b){this.xmlFiles.contains(b)||this.xmlFiles.push(b);var c=[],d=[];a.getElements(".gallery").each(function(e){var f={gallery:e.getProperty("name"),autoplay:Boolean(e.getProperty("autoplay")),delay:Number(e.getProperty("delay"))};
e=e.getChildren("a").map(function(g){return g.setProperty("rel","milkbox["+f.gallery+"]")});c.push(e);f.autoplay&&d.push(f)});this.prepareGalleries(c.flatten());this.setAutoPlay(d);this.activated||this.initMilkbox();this.fireEvent("xmlGalleries")},checkFileType:function(a,b){var c=null;c=$type(a)!="string"?a.retrieve("href"):a;var d=RegExp(".("+b+")$","i");return c.split("?")[0].test(d)},getGallery:function(a){var b=null;b=a.test(/^milkbox/i)?this.families:this.families.map(function(c){c=c.trim();
return c.slice(0,c.length).substr(8).replace(/(.+)]$/,"$1")});a=b.indexOf(a);return a!=-1?this.galleries[a]:a},setFileProps:function(a,b){b.split(",").each(function(c){c=c.trim().split(":");a.store(c[0].trim(),c[1].trim())},this)},changeOptions:function(a){if(a){this.setOptions(a);this.center.get("morph").setOptions({transition:this.options.resizeTransition,duration:this.options.resizeDuration})}},saveOptions:function(a){this.fullOptionsBkup=$chk(a)?a:this.options},restoreOptions:function(){this.setOptions(this.fullOptionsBkup);
this.canvas.setStyles({border:this.options.canvasBorderWidth+" solid "+this.options.canvasBorderColor,padding:this.options.canvasPadding});this.center.get("morph").setOptions({transition:this.options.resizeTransition,duration:this.options.resizeDuration})},reloadGalleries:function(){this.galleries=[];this.families=[];this.formtags=$$("select","textarea");this.activated||this.initMilkbox(false);this.prepareGalleries();this.removeGalleriesEvents();this.setGalleriesEvents();this.xmlFiles.length!=0&&
this.xmlFiles.each(function(a){this.addGalleries(a)}.bind(this))},setAutoPlay:function(a){($type(a)=="object"?[a]:a).each(function(b){var c=this.getGallery(b.gallery);if(c!=-1){var d=b.autoplay==true?b.autoplay:false;b=$chk(b.delay)&&d?b.delay:this.options.autoPlayDelay;c.options={autoplay:d,delay:b}}},this)},startAutoPlay:function(a){var b=-1,c;if(a&&a.gallery)if($type(a.gallery)=="array")b=a.gallery;else if($type(a.gallery)=="string")b=this.getGallery(a.gallery);if(b==-1)b=this.galleries[0];c=a&&
a.delay&&$type(a.delay)=="number"?a.delay*1E3:b.options&&b.options.delay?b.options.delay*1E3:this.options.autoPlayDelay*1E3;a=a&&a.index&&$type(a.index)=="number"?a.index:0;if(c<this.options.resizeDuration*2)c=this.options.resizeDuration*2;this.options.autoPlayDelay=c/1E3;this.options.autoPlay||this.setOptions({autoPlay:true,autoPlayDelay:this.options.autoPlayDelay});if(this.closed){this.openMilkbox(b,a);if(this.mode!="fileGallery")return;this.addEvent("fileReady",function(){this.intObj=this.next_prev_aux.periodical(c,
this,[null,"next"]);this.removeEvents("fileReady")}.bindWithEvent(this))}else{this.closed||this.next_prev_aux(null,"next");this.intObj=this.next_prev_aux.periodical(c,this,[null,"next"])}this.paused=false},stopAutoPlay:function(){if(this.intObj){$clear(this.intObj);this.intObj=null}this.playpause.setStyle("backgroundPosition","0 -44px");this.paused=true},removeGalleriesEvents:function(){this.galleries.each(function(a){$$(a).removeEvents("click")},this)},setGalleriesEvents:function(){this.galleries.each(function(a){$$(a).addEvent("click",
function(b){var c=$(b.target).match("a")?$(b.target):$(b.target).getParent("a");b.preventDefault();b=this.getGallery(c.rel);b.options&&b.options.autoplay&&this.setOptions({autoPlay:b.options.autoplay,autoPlayDelay:b.options.delay});this.options.autoPlay?this.startAutoPlay({gallery:a,index:a.indexOf(c)}):this.openMilkbox(a,a.indexOf(c))}.bindWithEvent(this))},this)},prepareEvents:function(){this.setGalleriesEvents();this.next.addEvent("click",this.next_prev_aux.bindWithEvent(this,"next"));this.prev.addEvent("click",
this.next_prev_aux.bindWithEvent(this,"prev"));$$(this.next,this.prev,this.close).addEvents({mouseover:function(){this.setStyle("backgroundPosition","0 -22px")},mouseout:function(){this.setStyle("backgroundPosition","0 0")}});$(window.document).addEvent("keydown",function(a){if(!(this.mode!="fileGallery"||this.busy==true))if(a.key=="right"||a.key=="space")this.next_prev_aux(a,"next");else if(a.key=="left")this.next_prev_aux(a,"prev");else a.key=="esc"&&this.closeMilkbox()}.bindWithEvent(this));this.playpause.addEvents({mouseover:function(){this.paused==
false?this.playpause.setStyle("backgroundPosition","0 -22px"):this.playpause.setStyle("backgroundPosition","0 -66px")}.bindWithEvent(this),mouseout:function(){this.paused==false?this.playpause.setStyle("backgroundPosition","0 0"):this.playpause.setStyle("backgroundPosition","0 -44px")}.bindWithEvent(this),click:function(){if(this.paused==false){this.stopAutoPlay();this.paused=true;this.playpause.setStyle("backgroundPosition","0 -66px")}else{this.startAutoPlay({gallery:this.currentGallery,index:this.currentIndex+
1,delay:this.currentGallery.options&&this.currentGallery.options.delay?this.currentGallery.options.delay:this.options.autoPlayDelay});this.paused=false;this.playpause.setStyle("backgroundPosition","0 0")}}.bindWithEvent(this)});this.overlay.get("tween").addEvent("onComplete",function(){if(this.overlay.getStyle("opacity")==this.options.overlayOpacity)this.center.tween("opacity",1);else this.overlay.getStyle("opacity")==0&&this.overlay.setStyles({height:0,top:""})}.bindWithEvent(this));this.center.get("morph").addEvent("onComplete",
function(){$type(this.currentFile)=="element"?this.canvas.grab(this.currentFile):function(){this.canvas.grab(this.currentFile)}.delay(500,this);this.canvas.tween("opacity",1);var a=this.mode!="showThisImage"?this.currentGallery[this.currentIndex].retrieve("title"):this.specialDescription;if($chk(a))this.description.innerHTML=a;this.mode=="fileGallery"&&this.count.appendText(this.currentIndex+1+" "+this.options.imageOfText+" "+this.currentGallery.length);a=this.center.getStyle("height").toInt();this.navigation.setStyle("height",
this.bottom.getStyle("height").toInt());var b=this.bottom.getSize().y;b=a>this.canvas.getSize().y?this.bottom.getSize().y+this.canvas.getSize().y-a:b;this.bottom.setStyle("display","none");this.center.retrieve("setFinalHeight").start(a,a+b)}.bindWithEvent(this));this.center.retrieve("setFinalHeight").addEvent("onComplete",function(){this.bottom.setStyles({visibility:"visible",display:"block"});$$(this.description,this.navigation).setStyle("visibility","visible");var a=$(window).getScrollSize().y,
b=$(window).getScroll().y;this.overlay.setStyles({height:a+b,top:-b});this.busy=false}.bindWithEvent(this));window.addEvent("resize",function(){if(this.overlay.getStyle("opacity")!=0){var a=$(window).getScrollSize().y,b=$(window).getScroll().y;this.overlay.setStyles({height:a+b,top:-b})}}.bindWithEvent(this));$$(this.overlay,this.close).addEvent("click",this.closeMilkbox.bindWithEvent(this));this.eventsok=true},next_prev_aux:function(a,b){if(a){a.preventDefault();this.stopAutoPlay()}else if(this.busy||
!this.fileReady)return;this.busy=true;var c,d;if(b=="next"){c=this.currentIndex!=this.currentGallery.length-1?this.currentIndex+=1:this.currentIndex=0;d=this.currentIndex!=this.currentGallery.length-1?this.currentIndex+1:0}else{c=this.currentIndex!=0?this.currentIndex-=1:this.currentIndex=this.currentGallery.length-1;d=this.currentIndex!=0?this.currentIndex-1:this.currentGallery.length-1}this.canvas.empty();this.description.empty();this.count.empty();this.loadFile(this.currentGallery[c],[this.currentGallery[d]])},
prepareEffects:function(){this.overlay.set("tween",{duration:"short",link:"cancel"});this.center.set("tween",{duration:"short",link:"chain"});this.center.set("morph",{duration:this.options.resizeDuration,link:"chain",transition:this.options.resizeTransition});this.center.store("setFinalHeight",new Fx.Tween(this.center,{property:"height",duration:"short"}));this.canvas.set("tween",{link:"chain"})},prepareGalleries:function(a){var b=[];(a?a:$$("a")).each(function(c){if(c.rel&&c.rel.test(/^milkbox/i)&&
c.href.split("?")[0].test(/\.(gif|jpg|jpeg|png|swf)$/i)){c.rel.length>7&&!this.families.contains(c.rel)&&this.families.push(c.rel);b.push(c)}},this);b.each(function(c){$(c).store("href",c.href);$(c).store("rel",c.rel);$(c).store("title",c.title);this.checkFileType(c.href,"swf")&&this.setFileProps($(c),c.rev);this.options.removeTitle&&$(c).removeProperty("title");c.rel.length>7?this.families.each(function(d){if(c.rel==d){var e=false,f;this.galleries.each(function(g,h){if(g[0].rel==d){e=true;f=h}});
e==true?this.galleries[f].push($(c)):this.galleries.push([$(c)])}},this):this.galleries.push([$(c)])},this)},prepareHTML:function(){this.overlay=(new Element("div",{id:"mbOverlay",styles:{opacity:0,visibility:"visible",height:0,overflow:"hidden"}})).inject($(document.body));this.center=(new Element("div",{id:"mbCenter",styles:{width:this.options.initialWidth,height:this.options.initialHeight,marginLeft:-(this.options.initialWidth/2),opacity:0}})).inject($(document.body));this.canvas=(new Element("div",
{id:"mbCanvas"})).inject(this.center);this.bottom=(new Element("div",{id:"mbBottom"})).inject(this.center).setStyle("visibility","hidden");this.navigation=(new Element("div",{id:"mbNavigation"})).setStyle("visibility","hidden");this.description=(new Element("div",{id:"mbDescription"})).setStyle("visibility","hidden");this.bottom.adopt(this.navigation,this.description,new Element("div",{"class":"mbClear"}));this.close=new Element("a",{id:"mbCloseLink"});this.next=new Element("a",{id:"mbNextLink"});
this.prev=new Element("a",{id:"mbPrevLink"});this.playpause=new Element("a",{id:"mbPlayPause"});this.count=new Element("span",{id:"mbCount"});$$(this.next,this.prev,this.count,this.playpause).setStyle("display","none");this.navigation.adopt(this.close,this.next,this.prev,this.playpause,new Element("div",{"class":"mbClear"}),this.count)},closeMilkbox:function(){this.cancelAllEffects();this.stopAutoPlay();this.setOptions(this.autoPlayBkup);this.currentResponse=this.currentRequest=this.currentGallery=
this.currentIndex=this.currentFile=null;$$(this.prev,this.next,this.playpause,this.count).setStyle("display","none");this.playpause.setStyle("backgroundPosition","0 0");var a=this.center.getStyle("border-right-width").toInt();a=this.close.getSize().x+a;this.navigation.setStyles({width:a,height:"",visibility:"hidden"});this.description.setStyle("margin-right",a);this.description.empty();this.bottom.setStyles({visibility:"hidden",display:""});this.canvas.setStyles({opacity:0,width:"",height:""});this.canvas.empty();
this.count.empty();this.center.setStyles({opacity:0,width:this.options.initialWidth,height:this.options.initialHeight,marginLeft:-(this.options.initialWidth/2)});this.overlay.tween("opacity",0);this.formtags&&this.formtags.length!=0&&this.formtags.setStyle("display","");this.mode=null;this.first=this.closed=true;this.fileReady=false;this.fireEvent("closed")},cancelAllEffects:function(){this.overlay.get("tween").cancel();this.center.get("morph").cancel();this.center.get("tween").cancel();this.center.retrieve("setFinalHeight").cancel();
this.canvas.get("tween").cancel()}});window.addEvent("domready",function(){milkbox=new Milkbox});
